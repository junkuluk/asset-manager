import streamlit as st
import pandas as pd
from datetime import date
from core.db_queries import get_annual_summary_data
from core.ui_utils import apply_common_styles
import numpy as np

apply_common_styles()
st.set_page_config(layout="wide", page_title="ì—°ê°„ ì¬ë¬´ ìš”ì•½")
st.title("ğŸ“… ì—°ê°„ ì¬ë¬´ ìš”ì•½")
st.markdown("ì„ íƒëœ ì—°ë„ì˜ ìˆ˜ì…, ì§€ì¶œ, íˆ¬ì í˜„í™©ê³¼ í˜„ê¸ˆ íë¦„ì„ ìš”ì•½í•©ë‹ˆë‹¤.")
st.markdown("---")

# --- ì—°ë„ ì„ íƒ UI ---
current_year = date.today().year
selected_year = st.selectbox(
    "ì¡°íšŒ ì—°ë„",
    options=range(current_year, 2019, -1),
    index=0
)
st.markdown("---")

# --- ë°ì´í„° ë¡œë“œ ---
source_df = get_annual_summary_data(selected_year)

if source_df.empty:
    st.warning(f"{selected_year}ë…„ì—ëŠ” ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    # --- ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ìµœì¢… ë¡œì§ì…ë‹ˆë‹¤ ---

    # 1. ê¸°ë³¸ í”¼ë²— í…Œì´ë¸” ìƒì„± (ë°ì´í„°ê°€ ìˆëŠ” í•­ëª©ë§Œ í¬í•¨ë¨)
    #all_months_of_year = [f"{selected_year}/{str(m).zfill(2)}" for m in range(1, 13)]
    #source_df['ì—°ì›”'] = pd.Categorical(source_df['ì—°ì›”'], categories=all_months_of_year, ordered=True)

    pivot_data = pd.pivot_table(
        source_df, index=['êµ¬ë¶„', 'í•­ëª©'], columns='ì—°ì›”',
        values='ê¸ˆì•¡', aggfunc='sum', fill_value=0, dropna=False
    )

    all_months_of_year = [f"{selected_year}/{str(m).zfill(2)}" for m in range(1, 13)]
    pivot_df = pivot_data.reindex(columns=all_months_of_year, fill_value=0)

    # 2. ìµœì¢… ë³´ê³ ì„œì— í‘œì‹œë  í–‰ì˜ ìˆœì„œì™€ êµ¬ì¡°ë¥¼ ì§ì ‘ ì •ì˜
    report_structure = [
        ('ìˆ˜ì…', 'ê³ ì • ìˆ˜ì…'), ('ìˆ˜ì…', 'ë³€ë™ ìˆ˜ì…'), ('ìˆ˜ì…', 'ë¯¸ë¶„ë¥˜ ìˆ˜ì…'), ('ìˆ˜ì…', 'ìˆ˜ì… ì†Œê³„'),
        ('ì§€ì¶œ', 'ê³ ì • ì§€ì¶œ'), ('ì§€ì¶œ', 'ë³€ë™ ì§€ì¶œ'), ('ì§€ì¶œ', 'ë¯¸ë¶„ë¥˜ ì§€ì¶œ'), ('ì§€ì¶œ', 'ì§€ì¶œ ì†Œê³„'),
        ('íˆ¬ì', 'íˆ¬ì'), ('íˆ¬ì', 'íˆ¬ì ì†Œê³„'),
        ('í˜„ê¸ˆíë¦„', 'íˆ¬ìê°€ëŠ¥ê¸ˆì•¡ (ìˆ˜ì…-ì§€ì¶œ)'),
        ('í˜„ê¸ˆíë¦„', 'ìµœì¢… í˜„ê¸ˆ ë³€ë™')
    ]
    report_index = pd.MultiIndex.from_tuples(report_structure, names=['êµ¬ë¶„', 'í•­ëª©'])

    # 3. ì •ì˜ëœ êµ¬ì¡°ë¥¼ ê°€ì§„ ë¹ˆ ë³´ê³ ì„œ 'í‹€' ìƒì„±
    report_df = pd.DataFrame(0, index=report_index, columns=pivot_data.columns)

    # 4. 'í‹€'ì— ì‹¤ì œ í”¼ë²— ë°ì´í„° ê°’ì„ ì±„ì›Œë„£ê¸° (ìˆëŠ” ê°’ë§Œ ì—…ë°ì´íŠ¸)
    report_df.update(pivot_data)

    # 5. ì†Œê³„ ë° ìš”ì•½ í–‰ì„ ì§ì ‘ ê³„ì‚°í•˜ì—¬ ì±„ì›Œë„£ê¸°
    income_sum = report_df.loc['ìˆ˜ì…', :'ë¯¸ë¶„ë¥˜ ìˆ˜ì…'].sum()
    expense_sum = report_df.loc['ì§€ì¶œ', :'ë¯¸ë¶„ë¥˜ ì§€ì¶œ'].sum()
    invest_sum = report_df.loc['íˆ¬ì', :'íˆ¬ì'].sum()  # 'íˆ¬ì' í•­ëª©ì´ í•˜ë‚˜ì´ë¯€ë¡œ ìê¸° ìì‹ ì´ ì†Œê³„

    report_df.loc[('ìˆ˜ì…', 'ìˆ˜ì… ì†Œê³„')] = income_sum
    report_df.loc[('ì§€ì¶œ', 'ì§€ì¶œ ì†Œê³„')] = expense_sum
    report_df.loc[('íˆ¬ì', 'íˆ¬ì ì†Œê³„')] = invest_sum

    report_df.loc[('í˜„ê¸ˆíë¦„', 'íˆ¬ìê°€ëŠ¥ê¸ˆì•¡ (ìˆ˜ì…-ì§€ì¶œ)')] = income_sum - expense_sum
    report_df.loc[('í˜„ê¸ˆíë¦„', 'ìµœì¢… í˜„ê¸ˆ ë³€ë™')] = income_sum - expense_sum - invest_sum

    # 6. 'ì—°ê°„ ì´í•©ê³„' ì»¬ëŸ¼ ì¶”ê°€
    report_df['Total'] = report_df.sum(axis=1)

    # ì¸ë±ìŠ¤ë¥¼ ì»¬ëŸ¼ìœ¼ë¡œ ë³€í™˜
    final_df_to_style = report_df.reset_index()

    # 7. Pandas ìŠ¤íƒ€ì¼ë§ ì ìš©
    numeric_cols = final_df_to_style.select_dtypes(include=np.number).columns.tolist()


    def highlight_rows(row):
        is_total = 'ì†Œê³„' in row['í•­ëª©'] or 'ê¸ˆì•¡' in row['í•­ëª©'] or 'ë³€ë™' in row['í•­ëª©']
        style = 'font-weight: bold; background-color: #f7f7f7' if is_total else ''
        return [style for _ in row]


    styled_df = final_df_to_style.style.apply(highlight_rows, axis=1) \
        .format("{:,.0f}", na_rep='-', subset=numeric_cols) \
        .hide(axis="index")

    # 8. ìµœì¢… ê²°ê³¼ë¬¼ í‘œì‹œ
    st.subheader(f"{selected_year}ë…„ ì›”ë³„ ìš”ì•½")
    st.dataframe(styled_df, use_container_width=True, hide_index=True, height=(len(final_df_to_style) + 1) * 35 + 3)