import numpy as np
import streamlit as st
import pandas as pd
from datetime import date
from core.db_queries import get_annual_summary_data
from st_aggrid import AgGrid, GridOptionsBuilder
from core.ui_utils import apply_common_styles

apply_common_styles()
st.set_page_config(layout="wide", page_title="ì—°ê°„ ì¬ë¬´ ìš”ì•½")
st.title("ğŸ“… ì—°ê°„ ì¬ë¬´ ìš”ì•½")
st.markdown("ì„ íƒëœ ì—°ë„ì˜ ìˆ˜ì…, ì§€ì¶œ, íˆ¬ì í˜„í™©ê³¼ í˜„ê¸ˆ íë¦„ì„ ìš”ì•½í•©ë‹ˆë‹¤.")
st.markdown("---")

# --- ì—°ë„ ì„ íƒ UI ---
current_year = date.today().year
selected_year = st.selectbox(
    "ì¡°íšŒ ì—°ë„",
    options=range(current_year, 2019, -1),
    index=0
)

st.markdown("---")

# --- ë°ì´í„° ë¡œë“œ ---
source_df = get_annual_summary_data(selected_year)

if source_df.empty:
    st.warning(f"{selected_year}ë…„ì—ëŠ” ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    # --- ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ìµœì¢… ë¡œì§ì…ë‹ˆë‹¤ ---

    # 1. ëª¨ë“  ì›” ëª©ë¡ì„ ë¯¸ë¦¬ ìƒì„±
    all_months_of_year = [f"{selected_year}/{str(m).zfill(2)}" for m in range(1, 13)]
    source_df['ì—°ì›”'] = pd.Categorical(source_df['ì—°ì›”'], categories=all_months_of_year, ordered=True)

    # 2. ê¸°ë³¸ í”¼ë²— í…Œì´ë¸” ìƒì„± (margins ì‚¬ìš© ì•ˆ í•¨)
    pivot_df = pd.pivot_table(
        source_df,
        index=['êµ¬ë¶„', 'í•­ëª©'],
        columns='ì—°ì›”',
        values='ê¸ˆì•¡',
        aggfunc='sum',
        fill_value=0,
        dropna=False
    )

    # 3. 'ì—°ê°„ ì´í•©ê³„' ì»¬ëŸ¼ì„ ë¨¼ì € ì¶”ê°€
    pivot_df['Total'] = pivot_df.sum(axis=1)

    subtotals = pivot_df.groupby(level='êµ¬ë¶„').sum()
    subtotals.index = pd.MultiIndex.from_tuples([(idx, f'{idx} ì†Œê³„') for idx in subtotals.index])

    # ì›ë³¸ í”¼ë²—ê³¼ ì†Œê³„ë¥¼ í•©ì¹¨
    final_df = pd.concat([pivot_df, subtotals]).sort_index()

    # --- ì—¬ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ---
    # 1. concatìœ¼ë¡œ ìœ ì‹¤ëœ ì¸ë±ìŠ¤ ì´ë¦„ì„ ë‹¤ì‹œ ëª…í™•í•˜ê²Œ ì§€ì •í•©ë‹ˆë‹¤.
    final_df.index.names = ['êµ¬ë¶„', 'í•­ëª©']

    # 2. ì´ì œ 'ìˆ˜ì…'ê³¼ 'ì§€ì¶œ' í–‰ì„ ì•ˆì „í•˜ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    income_total = final_df.loc[('ìˆ˜ì…', 'ìˆ˜ì… ì†Œê³„')] if ('ìˆ˜ì…', 'ìˆ˜ì… ì†Œê³„') in final_df.index else 0
    expense_total = final_df.loc[('ì§€ì¶œ', 'ì§€ì¶œ ì†Œê³„')] if ('ì§€ì¶œ', 'ì§€ì¶œ ì†Œê³„') in final_df.index else 0

    investable_cash_flow = income_total - expense_total
    investable_cash_flow.name = ('í˜„ê¸ˆíë¦„', 'íˆ¬ìê°€ëŠ¥ê¸ˆì•¡ (ìˆ˜ì…-ì§€ì¶œ)')

    final_df = pd.concat([final_df, investable_cash_flow.to_frame().T])

    # 'Total' ì»¬ëŸ¼ ì¶”ê°€ ë° ìµœì¢… ì¸ë±ìŠ¤ ë¦¬ì…‹
    final_df['Total'] = final_df.sum(axis=1)
    final_df.index.names = ['êµ¬ë¶„', 'í•­ëª©']  # concat í›„ ë‹¤ì‹œ í•œë²ˆ ì´ë¦„ ì§€ì •
    final_df.reset_index(inplace=True)

    # 6. Pandas ìŠ¤íƒ€ì¼ë§
    numeric_cols = final_df.select_dtypes(include=np.number).columns.tolist()


    def highlight_totals(row):
        is_total = 'ì†Œê³„' in row['í•­ëª©'] or 'íˆ¬ìê°€ëŠ¥ê¸ˆì•¡' in row['í•­ëª©']
        return ['font-weight: bold; background-color: #f5f5f5' if is_total else '' for _ in row]


    styled_df = final_df.style.apply(highlight_totals, axis=1) \
        .format("{:,.0f}", na_rep='-', subset=numeric_cols) \
        .set_properties(subset=numeric_cols, **{'text-align': 'right'}) \
        .hide(axis="index")

    # 7. ìµœì¢… ê²°ê³¼ë¬¼ í‘œì‹œ
    st.subheader(f"{selected_year}ë…„ ì›”ë³„ ìš”ì•½")
    st.dataframe(
        styled_df,
        use_container_width=True,
        height=(len(final_df) + 1) * 35 + 3,
        hide_index=True  # <<< ì´ ì˜µì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    )