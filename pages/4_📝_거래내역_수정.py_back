from datetime import date

import pandas as pd
import streamlit as st
from st_aggrid import AgGrid, GridUpdateMode, JsCode

from core.db_manager import update_transaction_category, update_transaction_description, update_transaction_party, \
    change_expense_to_transfer
from core.db_queries import load_data_from_db, get_all_categories, get_all_parties, get_all_accounts, \
    get_bank_expense_transactions
from core.ui_utils import apply_common_styles

import calendar

apply_common_styles()
st.set_page_config(layout="wide", page_title="ê±°ë˜ë‚´ì—­ ìƒì„¸ ìˆ˜ì •")

st.title("ğŸ“ ê±°ë˜ ë‚´ì—­ ìƒì„¸ ìˆ˜ì •")
st.markdown("""
- **ì¹´í…Œê³ ë¦¬/ë©”ëª¨/ê±°ë˜ì²˜ ë³€ê²½**: í•´ë‹¹ ì…€ì„ **ë”ë¸”í´ë¦­**í•˜ì—¬ ìˆ˜ì • í›„ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”.
 <span style='background-color: #fff9e6; border: 1px solid #e0e0e0; border-radius: 3px; padding: 2px 5px;'>ë…¸ë€ ë°°ê²½</span>ì˜ ì…€ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
""", unsafe_allow_html=True)

st.markdown("---")

def load_and_set_data():
    selected_year = st.session_state.editor_year
    selected_month = st.session_state.editor_month

    _, last_day = calendar.monthrange(selected_year, selected_month)

    start_date = date(selected_year, selected_month, 1)
    end_date = date(selected_year, selected_month, last_day)

    st.session_state.editor_df = load_data_from_db(
        start_date,
        end_date,
        st.session_state.editor_selected_types
    )
    # ë¹„êµë¥¼ ìœ„í•œ ì›ë³¸ ë°ì´í„° ë³µì‚¬ë³¸ë„ ì„¸ì…˜ ìƒíƒœì— ì €ì¥
    st.session_state.original_editor_df = st.session_state.editor_df.copy()


today = date.today()

if 'editor_year' not in st.session_state:
     #st.session_state.editor_start_date = date.today().replace(month=1, day=1)
     st.session_state.editor_year = today.year
if 'editor_month' not in st.session_state:
     #st.session_state.editor_end_date = date.today()
     st.session_state.editor_month = today.month
if 'editor_selected_types' not in st.session_state:
    st.session_state.editor_selected_types = ['EXPENSE', 'INCOME', 'INVEST']
if 'editor_df' not in st.session_state:
     load_and_set_data()


# --- ë‚ ì§œ í•„í„° UI ---
st.markdown("##### ì¡°íšŒ ê¸°ê°„ ì„ íƒ")
col1, col2, col3 = st.columns([1, 1, 2])
with col1:
    st.selectbox("ì—°ë„", range(today.year, 2019, -1), key="editor_year", on_change=load_and_set_data)
with col2:
    st.selectbox("ì›”", range(1, 13), key="editor_month", on_change=load_and_set_data)
with col3:
    st.multiselect(
        "ê±°ë˜ êµ¬ë¶„ í•„í„°",
        options=['EXPENSE', 'INCOME', 'INVEST'],
        key="editor_selected_types",
        on_change=load_and_set_data
    )

# --- ë°ì´í„° ë¡œë“œ ---
expense_categories = get_all_categories(category_type='EXPENSE')
income_categories = get_all_categories(category_type='INCOME')
invest_categories = get_all_categories(category_type='INVEST')

all_editable_categories = {**expense_categories, **income_categories, **invest_categories}
category_name_to_id_map = {v: k for k, v in all_editable_categories.items()}

party_map = get_all_parties()
party_desc_to_id_map = {v: k for k, v in party_map.items()}


if st.session_state.editor_df.empty:
    st.warning("ì„ íƒëœ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
else:
    # 1. JsCodeë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì  ë“œë¡­ë‹¤ìš´ ëª©ë¡ ìƒì„±
    jscode = JsCode(f"""
    function(params) {{
        // í˜„ì¬ í–‰ì˜ type ê°’ (EXPENSE, INCOME ë“±)ì„ ê°€ì ¸ì˜´
        var transactionType = params.data.type;

        // type ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë°˜í™˜
        if (transactionType === 'EXPENSE') {{
            return {{'values': {list(expense_categories.values())} }};
        }} else if (transactionType === 'INCOME') {{
            return {{'values': {list(income_categories.values())} }};
        }} else if (transactionType === 'INVEST') {{
            return {{'values': {list(invest_categories.values())} }};
        }} else {{
            return {{'values': [] }};
        }}
    }}
    """)

    editable_cell_style = {'backgroundColor': '#fff9e6'}

    # --- AgGrid ì„¤ì • ---
    gridOptions = {
        "columnDefs": [
            {"field": "id", "headerName": "ID", "width": 80, "editable": False},
            {"field": "type", "headerName": "êµ¬ë¶„", "width": 100, "editable": False},
            {"field": "transaction_date", "headerName": "ê±°ë˜ì¼ì‹œ", "width": 180, "sort": 'desc'},
            {"field": "content", "headerName": "ë‚´ìš©", "width": 250, "editable": False},
            {"field": "party_description", "headerName": "ê±°ë˜ì²˜", "width": 150, "cellEditor": 'agSelectCellEditor',
             "cellEditorParams": {'values': list(party_map.values())}, "cellStyle": editable_cell_style},
            {"field": "category_name", "headerName": "ì¹´í…Œê³ ë¦¬", "width": 150,
                "cellEditor": 'agSelectCellEditor',
                "cellEditorParams": jscode,
                "cellStyle": editable_cell_style},
            {"field": "transaction_amount", "headerName": "ê¸ˆì•¡", "width": 120, "valueFormatter": "x.toLocaleString()",
             "type": "numericColumn", "editable": False},
            {"field": "description", "headerName": "ë©”ëª¨", "width": 300, "cellStyle": editable_cell_style},
        ],
        "defaultColDef": {"sortable": True, "resizable": True, "editable": True},
        "pagination": True, "paginationPageSize": 20,
        "rowHeight": 32
    }

    custom_css = {
        # .ag-cellì— ì§ì ‘ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ì—¬ ìš°ì„ ìˆœìœ„ë¥¼ ë†’ì„
        ".ag-cell": {"font-size": "15px !important;"},
    }

    # --- AgGrid ì‹¤í–‰ ---
    grid_response = AgGrid(
        st.session_state.editor_df,
        gridOptions=gridOptions,
        custom_css=custom_css,
        key='transaction_grid_final_v2',  # í‚¤ ë³€ê²½ìœ¼ë¡œ ì™„ì „ ìƒˆë¡œê³ ì¹¨ ìœ ë„
        update_mode=GridUpdateMode.MODEL_CHANGED,
        allow_unsafe_jscode=True, height=700, theme='streamlit'
    )

    # --- ë³€ê²½ì‚¬í•­ DB ì—…ë°ì´íŠ¸ ë¡œì§ ---
    updated_df = grid_response['data']
    if not st.session_state.original_editor_df.equals(updated_df):
        try:
            comparison_df = pd.merge(st.session_state.original_editor_df, updated_df, on='id', suffixes=('_orig', '_new'))

            # fillna('')ë¥¼ í†µí•´ None ê°’ ë¹„êµ ì˜¤ë¥˜ ë°©ì§€
            cat_changed = comparison_df['category_name_orig'].fillna('') != comparison_df['category_name_new'].fillna(
                '')
            party_changed = comparison_df['party_description_orig'].fillna('') != comparison_df[
                'party_description_new'].fillna('')
            desc_changed = comparison_df['description_orig'].fillna('') != comparison_df['description_new'].fillna('')

            changed_rows = comparison_df[cat_changed | party_changed | desc_changed]

            if not changed_rows.empty:
                for _, row in changed_rows.iterrows():
                    transaction_id = row['id']

                    if row['category_name_orig'] != row['category_name_new']:
                        new_category_id = category_name_to_id_map.get(row['category_name_new'])
                        if new_category_id: update_transaction_category(transaction_id, new_category_id)

                    if row['party_description_orig'] != row['party_description_new']:
                        new_party_id = party_desc_to_id_map.get(row['party_description_new'])
                        if new_party_id: update_transaction_party(transaction_id, new_party_id)

                    if row['description_orig'] != row['description_new']:
                        update_transaction_description(transaction_id, row['description_new'])

                st.toast("ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
                load_and_set_data()  # DB ë³€ê²½ í›„ ì„¸ì…˜ ìƒíƒœë¥¼ ìµœì‹ ìœ¼ë¡œ ë‹¤ì‹œ ë¡œë“œ
                st.rerun()

        except Exception as e:
            st.error(f"ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

# --- AgGrid ì•„ë˜ì— ì´ ì„¹ì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤ ---
st.markdown("---")

with st.expander("ğŸ” ê±°ë˜ íƒ€ì… ìˆ˜ë™ ë³€ê²½ (ì§€ì¶œ â†’ ì´ì²´)"):
    st.write("ì€í–‰ ì¶œê¸ˆ ë‚´ì—­ ì¤‘ 'ì§€ì¶œ'ë¡œ ì˜ëª» ë¶„ë¥˜ëœ ì¹´ë“œê°’ ë‚©ë¶€ ë‚´ì—­ì„ 'ì´ì²´'ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.")

    selected_year = st.session_state.editor_year
    selected_month = st.session_state.editor_month

    _, last_day = calendar.monthrange(selected_year, selected_month)

    start_date = date(selected_year, selected_month, 1)
    end_date = date(selected_year, selected_month, last_day)
    # 1. ìœ„ì—ì„œ ì„ íƒëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½í•  í›„ë³´ ëª©ë¡ì„ ê°€ì ¸ì˜´
    candidate_df = get_bank_expense_transactions(
        start_date,
        end_date
    )

    if not candidate_df.empty:
        # 2. ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ì„ íƒì§€ ëª©ë¡ ìƒì„± (ë‚ ì§œ / ë‚´ìš© / ê¸ˆì•¡)
        candidate_df['display'] = candidate_df.apply(
            lambda row: f"{row['transaction_date']} / {row['content']} / {row['transaction_amount']:,}ì›",
            axis=1
        )
        options_map = pd.Series(candidate_df.id.values, index=candidate_df.display).to_dict()

        with st.form("change_type_form"):
            # 3. ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½í•  ê±°ë˜ ì„ íƒ
            selected_display = st.selectbox(
                "ì´ì²´ë¡œ ë³€ê²½í•  ê±°ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”:",
                options=options_map.keys()
            )

            # ì¹´ë“œ ê³„ì¢Œ ëª©ë¡ë§Œ ë¶ˆëŸ¬ì˜´
            card_accounts_map = get_all_accounts(account_type='CREDIT_CARD')
            paid_card_name = st.selectbox(
                "ì–´ë–¤ ì¹´ë“œì˜ ëŒ€ê¸ˆì„ ë‚©ë¶€í–ˆë‚˜ìš”?",
                options=list(card_accounts_map.keys())
            )

            submitted = st.form_submit_button("ì´ì²´ë¡œ ë³€ê²½ ì‹¤í–‰")
            if submitted:
                # 4. ì„ íƒëœ í•­ëª©ì˜ ì‹¤ì œ transaction IDë¥¼ ê°€ì ¸ì˜´
                transaction_id_to_change = options_map[selected_display]
                card_account_id = card_accounts_map[paid_card_name]

                success, message = change_expense_to_transfer(transaction_id_to_change, card_account_id)
                if success:
                    st.success(message)
                    st.rerun()  # ì„±ê³µ ì‹œ ì „ì²´ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                else:
                    st.error(message)
    else:
        st.info("ì„ íƒëœ ê¸°ê°„ì— ì´ì²´ë¡œ ë³€ê²½í•  'ì€í–‰ ì§€ì¶œ' ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")